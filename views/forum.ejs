<%- include('head') -%>
<%- include('header') -%>
<main class="forum-main main-background">
    <h1>Forum</h1>
    
    <%  if (locals.isLogged === true){ %>     
        <div class=addForum>
            <p>Vous ne trouvez pas votre bonheur ?</p>
            <button class="showAddForumForm">Créer un salon !</button></p>
        </div>
        
        
        <form method="post" class="salonForm display-none" action="/addSalon">
            <div>
                <label for="intitule">De quoi voulez vous parlez ?</label>
                <input type="text" name="intitule" id="intitule">     
            </div>
            <div>
                <button type="submit">Créer le salon !</button>
            </div>
        </form>
    <% } else { %>
        <p>Vous devez vous connecter pour créer un salon.</p>
        <a href=/login>Se connecter !</a>
    <% } %>
    
    <%for (const salon of forum){%>
        <form method="post" action=/deleteSalon>
            <div>
                <a class='list-forum salonForum' href=forum/<%= salon.id %>>
                    <div class="list-forum-image for-PC"><img class=image-profil src="images/profil/<%=salon.image%>"></div>
                    <div class="list-forum-infos">
                        <div class="list-forum-infos-detail">
                            <h3 class=nomSalon><%=salon.intitule%></h3>
                            <p>Créer par <%= salon.login %></p>
                        </div>
                        <div class="list-forum-infos-detail">
                            <p>Créer le<%= salon.date %></p>
                            <p class="for-PC">Dernier message le <%= salon.derniereUpdate %></p>
                            <p class="for-mobile"><%= salon.nbMessages %> messages</p>
                        </div>
                    </div>
                    <div class="list-forum-nbMessages" id="for-PC">
                        <p><%= salon.nbMessages %></p>
                        <p>messages</p>
                    </div>
                    
                    
                    
                   
                </a>
                <%  if (locals.role === "admin" || locals.role === "superadmin" || locals.role === "moderateur"){ %> 
                    <button type=submit>Supprimer le salon</button>
                    <input type="hidden" class="display-none" name="id" value="<%= salon.id %>">
                <% } %>
            </div>
        </form> 
        <%  if (locals.role === "admin" || locals.role === "superadmin" || locals.role === "moderateur"){ %> 
            <button class="edit-button">Modifier le nom du salon</button>
            <button class="save-button display-none" data-id="<%= salon.id %>">Valider</button>
        <% } %>
    <% } %>
    
    <script>
    
    document.addEventListener("DOMContentLoaded", function() {
        const showAddForumForm = document.querySelector(".showAddForumForm");
        const salonForm = document.querySelector(".salonForm");
        const addForum = document.querySelector(".addForum");

        // Ajoutez un gestionnaire d'événement au bouton pour afficher le formulaire
        showAddForumForm.addEventListener("click", function() {
            salonForm.classList.add('display-block');
            salonForm.classList.remove('display-none');
            addForum.classList.add('display-none');
            addForum.classList.remove('display-block');
            

        });
    });
    
    const editButton = document.querySelector('.edit-button');
    const saveButton = document.querySelector('.save-button');
    
    editButton.addEventListener('click', () => {
        event.preventDefault();
        const intituleSalon = document.querySelector('.nomSalon');
        const intituleSalonInput = document.createElement('input');
        intituleSalonInput.type = 'text';
        intituleSalonInput.value = intituleSalon.textContent;
        intituleSalon.textContent = '';
        intituleSalon.appendChild(intituleSalonInput);

        // Afficher le bouton "Valider" et masquer le bouton "Modifier"
        editButton.classList.add('display-none');
        editButton.classList.remove('display-block');
        saveButton.classList.add('display-block');
        saveButton.classList.remove('display-none');
        
        
        const ahref = document.querySelector('.salonForum');
        ahref.classList.add('display-none');
        ahref.classList.remove('display-block');
        
        ahref.onclick = function(event) {
                event.preventDefault(); // Empêche le lien de s'ouvrir
            };
    });
    
    saveButton.addEventListener('click', () => {
        const intituleSalonResult = document.querySelector('.nomSalon input');
        // Créer un objet FormData pour envoyer les données
        const formData = new FormData();
        
        formData.append('id',saveButton.dataset.id);
        formData.append('intitule', intituleSalonResult.value);
        
        // Effectuer une requête fetch pour envoyer les données
        fetch('/updateSalon', {
            method: 'POST',
            body: formData
        })
        .then((response) => {
            console.log(response)
            if (response.redirected===true){
               window.location.href = response.url
            } else {
                return response.json()
                .then((data) => {
                        // Traitez la réponse du serveur (par exemple, affichez un message de succès)
                        console.log("Récupération réussie");
                        window.location.reload()
                    })
            }
        })
                    
                    .catch((error) => {
                        // Gérez les erreurs (par exemple, affichez un message d'erreur)
                        console.error('Erreur lors de la mise à jour :', error);
                    });

    });
    
    
    
</script>
</main>
<%- include('footer') -%>